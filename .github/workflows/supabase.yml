name: Deploy Supabase Functions

on:
  push:
    branches: [main]
    paths:
      - 'supabase/**'
      - '.github/workflows/supabase.yml'
  workflow_dispatch:
    inputs:
      deploy_all:
        description: 'Force deploy all functions'
        required: false
        type: boolean
        default: false

permissions:
  contents: read

env:
  SUPABASE_PROJECT_ID: htruyldcvakkzpykfoxq

jobs:
  deploy-functions:
    name: Deploy Edge Functions
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Verify Supabase CLI installation
        run: supabase --version

      - name: Link to Supabase project
        run: |
          echo "Linking to Supabase project: $SUPABASE_PROJECT_ID"
          supabase link --project-ref $SUPABASE_PROJECT_ID
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

      - name: Deploy all functions
        run: |
          echo "Deploying Supabase Edge Functions..."
          supabase functions deploy --no-verify-jwt
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

      - name: Deployment summary
        run: |
          echo "## Supabase Functions Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ Successfully deployed Edge Functions to project: \`$SUPABASE_PROJECT_ID\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deployed Functions" >> $GITHUB_STEP_SUMMARY
          echo "Total functions in repository: $(find supabase/functions -maxdepth 1 -type d | wc -l)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY

  verify-deployment:
    name: Verify Deployment
    runs-on: ubuntu-latest
    needs: deploy-functions
    if: success()
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: false

      - name: Install dependencies
        run: npm ci

      - name: Test health check endpoint
        run: |
          echo "Testing health-check function..."
          HEALTH_URL="https://${{ env.SUPABASE_PROJECT_ID }}.supabase.co/functions/v1/health-check"
          
          # Wait for deployment to propagate
          sleep 10
          
          # Test the health check endpoint
          RESPONSE=$(curl -s -w "\n%{http_code}" "$HEALTH_URL" || echo "000")
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n-1)
          
          echo "Health check response code: $HTTP_CODE"
          echo "Response body: $BODY"
          
          if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "401" ]; then
            echo "✅ Functions are deployed and accessible"
            exit 0
          else
            echo "⚠️ Health check returned unexpected code: $HTTP_CODE"
            echo "This may be expected for protected endpoints"
            exit 0
          fi

      - name: Verification summary
        if: always()
        run: |
          echo "## Deployment Verification" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Functions are deployed to:" >> $GITHUB_STEP_SUMMARY
          echo "\`https://${{ env.SUPABASE_PROJECT_ID }}.supabase.co/functions/v1/\`" >> $GITHUB_STEP_SUMMARY
