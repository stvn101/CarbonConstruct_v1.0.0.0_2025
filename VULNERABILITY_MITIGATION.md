# Vulnerability Mitigation Documentation

This document tracks known vulnerabilities in dependencies and their mitigations.

## Current Status

âœ… **All critical and high-severity vulnerabilities with available fixes have been resolved.**

## Resolved Vulnerabilities

### 1. jsPDF Local File Inclusion/Path Traversal (CVE-2024-XXXX)
- **Severity**: Critical
- **Affected Package**: jspdf <=3.0.4 (via html2pdf.js)
- **Resolution Date**: 2026-01-06
- **Fix Applied**: 
  - Removed vulnerable `html2pdf.js@0.12.1` package
  - Created secure replacement: `src/lib/secure-html-to-pdf.ts`
  - Uses `html2canvas@1.4.1` + `jspdf@4.0.0` (safe version)
  - Updated all PDF generation code to use secure implementation
- **Files Modified**:
  - `src/components/SecurityAuditReport.tsx`
  - `src/components/MaterialVerificationReport.tsx`
  - `src/components/LCADashboard.tsx`
  - `src/pages/Reports.tsx`
  - `src/pages/Methodology.tsx`
  - `src/pages/MaterialDatabaseStatus.tsx`
  - `src/components/__tests__/PDFReport.test.tsx`
- **Verification**: All PDF generation functionality tested and working correctly

### 2. DOMPurify XSS Vulnerability (Transitive via jspdf@2.5.2)
- **Severity**: Moderate
- **Affected Package**: dompurify <3.2.4 (via jspdf@2.5.2)
- **Resolution Date**: 2026-01-06
- **Fix Applied**: 
  - Upgraded `jspdf` from `2.5.2` to `4.0.0`
  - jspdf@4.0.0 does not depend on dompurify (removed from dependencies)
- **Verification**: npm audit confirms vulnerability resolved

## Outstanding Vulnerabilities (No Fix Available)

### xlsx - Prototype Pollution and ReDoS
- **Severity**: High
- **CVE IDs**: 
  - GHSA-4r6h-8v6p-xvw6 (Prototype Pollution)
  - GHSA-5pgg-2g8v-p4x9 (ReDoS)
- **Affected Package**: xlsx (all versions)
- **Used In**:
  - `src/pages/BOQImport.tsx` - Bill of Quantities Excel file parsing
  - `src/pages/Calculator.tsx` - Material data import/export
- **Status**: No fix available as of 2026-01-06

#### Mitigation Strategy

**Current Mitigations in Place:**

1. **Input Source Control**:
   - xlsx is only used to process files uploaded by authenticated users
   - Files are user-controlled (Bill of Quantities and material exports)
   - No automatic processing of untrusted external files

2. **Usage Context**:
   - Used in client-side code only (browser sandbox)
   - Not exposed to server-side processing
   - Not used with untrusted network data

3. **Affected Attack Vectors**:
   - **Prototype Pollution**: Requires malicious Excel file crafted by attacker
   - **ReDoS**: Requires malicious regex patterns in Excel content
   - Both require user to deliberately upload a malicious file

4. **Risk Assessment**:
   - **Likelihood**: Low - requires authenticated user to upload malicious file to harm themselves
   - **Impact**: Medium - limited to client-side execution in user's browser
   - **Overall Risk**: Low-Medium

**Monitoring Plan:**

- Check for xlsx updates monthly: `npm outdated xlsx`
- Monitor security advisories: https://github.com/advisories?query=xlsx
- Track upstream issue: https://github.com/SheetJS/sheetjs/issues

**Alternative Packages Evaluated:**

1. **exceljs** - Already in use for other Excel operations
   - Pros: Actively maintained, no known high/critical vulnerabilities
   - Cons: Different API, requires significant refactoring
   - Decision: Consider for future refactoring if vulnerability worsens

2. **xlsx-populate** - Alternative Excel library
   - Pros: Simpler API
   - Cons: Less feature-rich, may have similar issues
   - Decision: Not worth switching without security benefit

3. **papaparse** (CSV only)
   - Pros: Secure, well-maintained
   - Cons: Doesn't support .xlsx format (only CSV)
   - Decision: Not suitable for current requirements

**Temporary Acceptance Justification:**

This vulnerability is accepted temporarily because:
1. No fix is available from the package maintainer
2. Risk is low due to controlled usage context (authenticated users only)
3. Attack requires user to deliberately harm themselves
4. Alternative packages don't provide significant security improvement
5. Client-side browser sandbox limits potential damage
6. Functionality is critical for Bill of Quantities import feature

**Review Date**: 2026-03-01 (or when fix becomes available)

## Security Scanning

- **Last Scan**: 2026-01-06
- **Tool**: npm audit
- **Critical**: 0
- **High**: 1 (xlsx - no fix available)
- **Moderate**: 0
- **Low**: 0

## Verification Commands

```bash
# Run security audit
npm audit

# Check for available updates
npm outdated

# Verify jspdf version (should be 4.0.0+)
npm list jspdf

# Verify html2pdf.js is removed
npm list html2pdf.js  # Should show (empty)
```

## Contact

For security concerns, please contact: security@carbonconstruct.com.au
